// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int       @id @default(autoincrement())
  
  firstName      String
  lastName       String
  birthDate      DateTime

  email          String    @unique
  passwordHash   String
  phoneNumber    String?   @unique
  walletAddress  String?
  
  // Saldo & Stats
  coinsBalance   Decimal   @default(0.0) @db.Decimal(18, 2)
  dayStreak      Int       @default(0)
  lastWorkout    DateTime?
  totalWorkouts  Int       @default(0)

  avatarGender   String    @default("MALE") 
  equippedTop    String    @default("starter_hair")
  equippedShirt  String    @default("starter_shirt")
  equippedPants  String    @default("starter_pants")
  equippedShoes  String    @default("starter_shoes")

  // Relasi
  blockedApps       BlockedApp[]
  inventory         Inventory[]
  workoutPrefs      WorkoutPreference[]
  transactionQueue  TransactionQueue[]
  purchases         PurchaseHistory[]
  
  createdAt         DateTime  @default(now())
}

model BlockedApp {
  id        Int     @id @default(autoincrement())
  userId    Int
  appName   String
  isActive  Boolean @default(true)
  user      User    @relation(fields: [userId], references: [id])
}

model WorkoutPreference {
  id        Int     @id @default(autoincrement())
  userId    Int
  type      String
  target    Int
  isEnabled Boolean @default(true)
  user      User    @relation(fields: [userId], references: [id])
}

model Inventory {
  id        Int      @id @default(autoincrement())
  userId    Int
  itemId    String   // ID unik item (misal: "hat_cowboy")
  itemType  String   // TOP, SHIRT, PANTS, SHOES
  isOwned   Boolean  @default(true)
  user      User     @relation(fields: [userId], references: [id])

  // UPDATE PENTING: Mencegah duplikasi item yang sama untuk satu user
  @@unique([userId, itemId])
}

// Tabel Antrian untuk Worker Blockchain (Minting)
model TransactionQueue {
  id            Int      @id @default(autoincrement())
  userId        Int
  walletAddress String
  amount        String
  workoutType   String
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  txHash        String?
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
}

// Tabel Riwayat Pembelian (Mencegah Replay Attack)
model PurchaseHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  itemId    String
  txHash    String   @unique // Hash transaksi tidak boleh dipakai 2x
  amount    String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
}